[
  {
    "_id": "users",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "wallet_address": {
              "type": "string",
              "pattern": "^0x[a-fA-F0-9]{40}$",
              "unique": true,
              "description": "Ethereum wallet address"
            },
            "nonce": { "type": "string", "minLength": 32, "maxLength": 64 },
            "nonce_expires_at": { "type": "string", "format": "date-time" },
            "last_login_at": { "type": "string", "format": "date-time" },
            "roles": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "role_type": {
                    "type": "string",
                    "enum": ["customer", "company_owner", "company_admin"]
                  },
                  "entity_id": { "type": "string" },
                  "status": {
                    "type": "string",
                    "enum": ["active", "suspended", "pending"]
                  },
                  "assigned_by": { "type": "string" },
                  "assigned_at": { "type": "string", "format": "date-time" },
                  "evidence": {
                    "type": "object",
                    "properties": {
                      "source_collection": { "type": "string" },
                      "record_id": { "type": "string" },
                      "verification_method": {
                        "type": "string",
                        "enum": [
                          "wallet_match",
                          "document_verified",
                          "invite_code"
                        ]
                      }
                    },
                    "required": [
                      "source_collection",
                      "record_id",
                      "verification_method"
                    ]
                  }
                },
                "required": [
                  "role_type",
                  "entity_id",
                  "assigned_by",
                  "assigned_at",
                  "evidence"
                ]
              }
            },
            "created_at": { "type": "string", "format": "date-time" },
            "updated_at": { "type": "string", "format": "date-time" }
          },
          "required": [
            "wallet_address",
            "nonce",
            "nonce_expires_at",
            "roles",
            "created_at",
            "updated_at"
          ],
          "additionalProperties": false
        }
      }
    }
  },
  {
    "_id": "company_registrations",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "company_id": { "type": "string", "unique": true },
            "applicant_wallet": {
              "type": "string",
              "pattern": "^0x[a-fA-F0-9]{40}$",
              "description": "Người nộp hồ sơ (sẽ trở thành company_owner nếu được duyệt)"
            },
            "business_name": { "type": "string" },
            "tax_code": { "type": "string", "unique": true },
            "registration_document": {
              "type": "object",
              "properties": {
                "file_cid": {
                  "type": "string",
                  "description": "IPFS CID của giấy phép kinh doanh"
                },
                "ocr_verified": { "type": "boolean", "default": false },
                "ocr_data": { "type": "object" },
                "verified_by_admin": { "type": "boolean", "default": false },
                "verified_at": { "type": "string", "format": "date-time" }
              },
              "required": ["file_cid"]
            },
            "contact_info": {
              "type": "object",
              "properties": {
                "email": { "type": "string", "format": "email" },
                "phone": { "type": "string" }
              }
            },
            "address": {
              "type": "object",
              "properties": {
                "street": { "type": "string" },
                "ward": { "type": "string" },
                "district": { "type": "string" },
                "city": { "type": "string" },
                "country": { "type": "string" }
              }
            },
            "type": {
              "type": "string",
              "enum": [
                "manufacturer",
                "supplier",
                "distributor",
                "logistics_provider",
                "carrier",
                "warehouse",
                "retailer",
                "customs_broker",
                "financial_institution",
                "other"
              ],
              "description": "Phân loại loại hình doanh nghiệp trong chuỗi logistics"
            },
            "status": {
              "type": "string",
              "enum": ["pending", "approved", "rejected"],
              "default": "pending"
            },
            "approved_by": { "type": "string" },
            "approved_at": { "type": "string", "format": "date-time" },
            "created_at": { "type": "string", "format": "date-time" },
            "updated_at": { "type": "string", "format": "date-time" }
          },
          "required": [
            "applicant_wallet",
            "business_name",
            "tax_code",
            "registration_document",
            "status",
            "created_at",
            "updated_at"
          ],
          "additionalProperties": false
        }
      }
    }
  },
  {
    "_id": "transport_recommendations",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "TransportRecommendation",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },

            "request": {
              "type": "object",
              "properties": {
                "customer_wallet": {
                  "type": "string",
                  "pattern": "^0x[a-fA-F0-9]{40}$"
                },
                "pickup": {
                  "type": "object",
                  "properties": {
                    "address": { "type": "string" },
                    "country_code": {
                      "type": "string",
                      "pattern": "^[A-Z]{2}$"
                    },
                    "geo": {
                      "type": "array",
                      "items": { "type": "number" },
                      "minItems": 2,
                      "maxItems": 2,
                      "description": "[longitude, latitude]"
                    },
                    "earliest": { "type": "string", "format": "date-time" },
                    "latest": { "type": "string", "format": "date-time" }
                  },
                  "required": ["geo", "country_code", "earliest"]
                },
                "delivery": {
                  "type": "object",
                  "properties": {
                    "address": { "type": "string" },
                    "country_code": {
                      "type": "string",
                      "pattern": "^[A-Z]{2}$"
                    },
                    "geo": {
                      "type": "array",
                      "items": { "type": "number" },
                      "minItems": 2,
                      "maxItems": 2
                    },
                    "latest": { "type": "string", "format": "date-time" }
                  },
                  "required": ["geo", "country_code", "latest"]
                },
                "cargo": {
                  "type": "object",
                  "properties": {
                    "description": { "type": "string" },
                    "weight_kg": { "type": "number", "minimum": 0 },
                    "volume_m3": { "type": "number", "minimum": 0 },
                    "is_hazardous": { "type": "boolean", "default": false },
                    "msds_cid": { "type": "string" },
                    "temperature_required": { "type": "number" },
                    "stackable": { "type": "boolean", "default": true }
                  },
                  "required": ["weight_kg", "volume_m3"]
                },
                "preferences": {
                  "type": "object",
                  "properties": {
                    "max_price_usd": { "type": "number" },
                    "allow_consolidation": {
                      "type": "boolean",
                      "default": true
                    },
                    "require_empty_container_return": {
                      "type": "boolean",
                      "default": false
                    },
                    "optimize_for": {
                      "type": "string",
                      "enum": [
                        "fastest_time",
                        "lowest_cost",
                        "lowest_emission",
                        "weather_safe",
                        "balanced"
                      ],
                      "default": "balanced",
                      "description": "Mục tiêu tối ưu hóa chính của người dùng"
                    }
                  }
                }
              },
              "required": ["customer_wallet", "pickup", "delivery", "cargo"]
            },

            "recommendations": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "company_id": { "type": "string" },
                  "score": { "type": "number", "minimum": 0, "maximum": 1 },
                  "score_breakdown": {
                    "type": "object",
                    "properties": {
                      "time_score": {
                        "type": "number",
                        "minimum": 0,
                        "maximum": 1
                      },
                      "weather_score": {
                        "type": "number",
                        "minimum": 0,
                        "maximum": 1
                      },
                      "customs_score": {
                        "type": "number",
                        "minimum": 0,
                        "maximum": 1
                      },
                      "fuel_score": {
                        "type": "number",
                        "minimum": 0,
                        "maximum": 1
                      },
                      "esg_score": {
                        "type": "number",
                        "minimum": 0,
                        "maximum": 1
                      },
                      "capability_score": {
                        "type": "number",
                        "minimum": 0,
                        "maximum": 1
                      }
                    },
                    "additionalProperties": false
                  },
                  "reasons": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "enum": [
                        "in_service_area",
                        "has_required_capability",
                        "available_now",
                        "good_on_time_rate",
                        "accepts_hazardous",
                        "offers_consolidation",
                        "has_empty_container_near_pickup",
                        "low_weather_risk",
                        "low_customs_risk",
                        "low_emission_route",
                        "fuel_efficient_vehicle"
                      ]
                    }
                  },
                  "estimated_price_usd": { "type": "number" },
                  "estimated_transit_hours": { "type": "number" },
                  "best_route": {
                    "type": "object",
                    "properties": {
                      "mode_sequence": {
                        "type": "array",
                        "items": {
                          "type": "string",
                          "enum": ["road", "sea", "rail", "air"]
                        }
                      },
                      "total_distance_km": { "type": "number", "minimum": 0 },
                      "total_eta_hours": { "type": "number", "minimum": 0 },
                      "total_fuel_l": { "type": "number", "minimum": 0 },
                      "total_co2_kg": { "type": "number", "minimum": 0 },
                      "legs": {
                        "type": "array",
                        "items": {
                          "type": "object",
                          "properties": {
                            "mode": {
                              "type": "string",
                              "enum": ["road", "sea", "rail", "air"]
                            },
                            "from_geo": {
                              "type": "array",
                              "items": { "type": "number" },
                              "minItems": 2,
                              "maxItems": 2
                            },
                            "to_geo": {
                              "type": "array",
                              "items": { "type": "number" },
                              "minItems": 2,
                              "maxItems": 2
                            },
                            "distance_km": { "type": "number" },
                            "eta_hours": { "type": "number" },
                            "weather_risk": {
                              "type": "number",
                              "minimum": 0,
                              "maximum": 1
                            },
                            "customs_risk": {
                              "type": "number",
                              "minimum": 0,
                              "maximum": 1
                            },
                            "fuel_l": { "type": "number" },
                            "co2_kg": { "type": "number" }
                          },
                          "required": [
                            "mode",
                            "from_geo",
                            "to_geo",
                            "distance_km",
                            "eta_hours"
                          ]
                        }
                      }
                    },
                    "required": [
                      "mode_sequence",
                      "total_distance_km",
                      "total_eta_hours"
                    ]
                  }
                },
                "required": ["company_id", "score"]
              }
            },

            "status": {
              "type": "string",
              "enum": ["pending", "processed", "failed"],
              "default": "pending"
            },
            "created_at": { "type": "string", "format": "date-time" },
            "processed_at": { "type": "string", "format": "date-time" }
          },
          "required": ["_id", "request", "created_at"],
          "additionalProperties": false
        }
      }
    }
  },
  {
    "_id": "transport_orders",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "TransportOrder",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },

            "order_ref": {
              "type": "string",
              "unique": true,
              "description": "Mã đơn hàng duy nhất"
            },

            "customer_wallet": {
              "type": "string",
              "pattern": "^0x[a-fA-F0-9]{40}$"
            },

            "carrier_wallet": {
              "type": "string",
              "pattern": "^0x[a-fA-F0-9]{40}$"
            },

            "selected_company_id": { "type": "string" },

            "is_matched": {
              "type": "boolean",
              "description": "true nếu đơn hàng dựa vào recommendation, false nếu người dùng tự chọn"
            },

            "source_request_id": {
              "type": ["string", "null"],
              "description": "Chỉ có nếu là matched — liên kết với transport_recommendations._id"
            },

            "selected_recommendation": {
              "type": ["object", "null"],
              "description": "Thông tin gợi ý được chọn nếu là matched",
              "properties": {
                "estimated_price_usd": { "type": "number" },
                "estimated_transit_hours": { "type": "number" },
                "best_route": { "type": "object" }
              }
            },

            "manual_selection": {
              "type": ["object", "null"],
              "description": "Thông tin user tự chọn nếu unmatched",
              "properties": {
                "price_usd": { "type": "number" },
                "transit_hours": { "type": "number" },
                "route": { "type": "object" },
                "notes": { "type": "string" }
              }
            },
            "cargo": {
              "type": "object",
              "properties": {
                "description": { "type": "string" },
                "weight_kg": { "type": "number" },
                "volume_cbm": { "type": "number" },
                "is_dangerous_goods": { "type": "boolean", "default": false },
                "un_class_number": {
                  "type": ["string", "null"],
                  "pattern": "^[1-9]$|^[1-8][0-9]?$|^9[0-9]?$"
                },
                "msds_document_cid": {
                  "type": ["string", "null"],
                  "description": "CID của MSDS trên IPFS"
                },
                "msds_verification_status": {
                  "type": "string",
                  "enum": ["not_required", "pending", "verified", "rejected"],
                  "default": "not_required"
                },
                "customs_hs_code": {
                  "type": ["string", "null"],
                  "description": "Mã HS cho hải quan"
                },
                "packaging_type": {
                  "type": "string",
                  "enum": ["container", "pallet", "drum", "bulk", "other"]
                }
              },
              "required": ["description", "weight_kg", "is_dangerous_goods"]
            },
            "pickup_proof": {
              "type": "object",
              "properties": {
                "image_hashes": {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "pattern": "^[a-f0-9]{64}$",
                    "description": "SHA-256 hash của ảnh gốc (binary) — không lưu ảnh, chỉ lưu hash"
                  },
                  "minItems": 1,
                  "description": "Danh sách hash SHA-256 của các ảnh hàng hóa do người gửi upload"
                },
                "uploaded_at": {
                  "type": "string",
                  "format": "date-time",
                  "description": "Thời gian upload ảnh (server time)"
                },
                "uploaded_by": {
                  "type": "string",
                  "pattern": "^0x[a-fA-F0-9]{40}$",
                  "description": "Wallet address của người dùng upload (customer_wallet)"
                },
                "location": {
                  "type": "object",
                  "properties": {
                    "lat": { "type": "number" },
                    "lng": { "type": "number" }
                  },
                  "description": "Vị trí GPS khi upload (nếu có)"
                },
                "device_info": {
                  "type": "object",
                  "properties": {
                    "user_agent": { "type": "string" },
                    "ip_address": { "type": "string" }
                  },
                  "description": "Thông tin thiết bị upload (dùng để audit)"
                }
              },
              "required": ["image_hashes", "uploaded_at", "uploaded_by"],
              "additionalProperties": false
            },
            "status": {
              "type": "string",
              "enum": [
                "pending_payment",
                "paid",
                "in_transit",
                "delivered",
                "disputed",
                "completed",
                "cancelled"
              ],
              "default": "pending_payment"
            },

            "payment": {
              "type": "object",
              "properties": {
                "escrow_id": { "type": ["string", "null"] },
                "token_used": {
                  "type": "string",
                  "pattern": "^0x[a-fA-F0-9]{40}$"
                },
                "amount_usd": { "type": "number" },
                "paid_at": { "type": ["string", "null"], "format": "date-time" }
              }
            },

            "delivery_proof_cid": { "type": ["string", "null"] },
            "created_at": { "type": "string", "format": "date-time" },
            "updated_at": { "type": "string", "format": "date-time" }
          },

          "required": [
            "order_ref",
            "customer_wallet",
            "selected_company_id",
            "is_matched",
            "status",
            "cargo",
            "pickup_proof",
            "created_at",
            "updated_at"
          ],

          "additionalProperties": false
        }
      }
    }
  },
  {
    "_id": "multi_party_contracts",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "contract_ref": {
              "type": "string",
              "unique": true,
              "description": "Mã hợp đồng duy nhất"
            },
            "order_ref": {
              "type": "string",
              "description": "Liên kết với transport_orders._id"
            },
            "parties": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "role": {
                    "type": "string",
                    "enum": ["buyer", "seller", "carrier"]
                  },
                  "wallet": {
                    "type": "string",
                    "pattern": "^0x[a-fA-F0-9]{40}$"
                  },
                  "signed": { "type": "boolean", "default": false },
                  "deposit_amount_token": { "type": "string" },
                  "deposit_paid_at": { "type": "string", "format": "date-time" }
                },
                "required": ["role", "wallet", "signed"]
              }
            },
            "escrow_id": {
              "type": "string",
              "description": "Liên kết với escrow_transactions._id"
            },
            "status": {
              "type": "string",
              "enum": [
                "pending_signatures",
                "active",
                "in_transit",
                "delivered",
                "disputed",
                "completed",
                "cancelled"
              ],
              "default": "pending_signatures"
            },
            "contract_terms": {
              "type": "object",
              "properties": {
                "delivery_deadline": {
                  "type": "string",
                  "format": "date-time"
                },
                "delivery_proof_required": {
                  "type": "boolean",
                  "default": true
                },
                "payment_release_condition": {
                  "type": "string",
                  "enum": ["proof_of_delivery", "manual_approval", "time_based"]
                },
                "penalty_rate": {
                  "type": "number",
                  "description": "Phần trăm phạt nếu giao trễ"
                }
              }
            },
            "created_at": { "type": "string", "format": "date-time" },
            "activated_at": { "type": "string", "format": "date-time" },
            "updated_at": { "type": "string", "format": "date-time" }
          },
          "required": [
            "order_ref",
            "parties",
            "status",
            "created_at",
            "updated_at"
          ],
          "additionalProperties": false
        }
      }
    }
  },
  {
    "_id": "escrow_transactions",
    "private": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "request_id": {
              "type": "string",
              "description": "Liên kết với transport_recommendations._id (tùy chọn)",
              "nullable": true
            },
            "contract_ref": {
              "type": "string",
              "description": "Liên kết với multi_party_contracts._id"
            },
            "customer_wallet": {
              "type": "string",
              "pattern": "^0x[a-fA-F0-9]{40}$"
            },
            "carrier_wallet": {
              "type": "string",
              "pattern": "^0x[a-fA-F0-9]{40}$"
            },
            "seller_wallet": {
              "type": "string",
              "pattern": "^0x[a-fA-F0-9]{40}$"
            },
            "amount_usd": { "type": "number", "minimum": 0 },
            "amount_token": {
              "type": "string",
              "description": "Số lượng token (wei hoặc smallest unit)"
            },
            "token_address": {
              "type": "string",
              "pattern": "^0x[a-fA-F0-9]{40}$"
            },
            "escrow_contract_address": {
              "type": "string",
              "pattern": "^0x[a-fA-F0-9]{40}$"
            },
            "status": {
              "type": "string",
              "enum": [
                "pending",
                "released",
                "refunded",
                "disputed",
                "cancelled"
              ]
            },
            "proof_of_delivery_cid": { "type": "string" },
            "created_at": { "type": "string", "format": "date-time" },
            "released_at": { "type": "string", "format": "date-time" },
            "refunded_at": { "type": "string", "format": "date-time" },
            "disputed_at": { "type": "string", "format": "date-time" },
            "disputed_by": {
              "type": "string",
              "enum": ["customer", "carrier", "seller", "none"]
            },
            "dao_resolution": {
              "type": "object",
              "properties": {
                "resolved": { "type": "boolean", "default": false },
                "voted_amount_to_carrier": { "type": "number", "minimum": 0 },
                "voted_amount_to_customer": { "type": "number", "minimum": 0 },
                "resolution_reason": { "type": "string" },
                "voted_at": { "type": "string", "format": "date-time" },
                "proposal_id": {
                  "type": "string",
                  "description": "Liên kết với dao_proposals._id"
                }
              },
              "additionalProperties": false
            }
          },
          "required": [
            "contract_ref",
            "customer_wallet",
            "carrier_wallet",
            "amount_token",
            "token_address",
            "escrow_contract_address",
            "status",
            "created_at"
          ],
          "additionalProperties": false
        }
      },
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "_id": { "$literal": "<CONTRACT_ID>" },
                  "status": "active"
                }
              },
              {
                "$addFields": {
                  "buyer_wallet": {
                    "$arrayElemAt": [
                      {
                        "$map": {
                          "input": "$parties",
                          "as": "p",
                          "in": {
                            "$cond": [
                              { "$eq": ["$$p.role", "buyer"] },
                              "$$p.wallet",
                              null
                            ]
                          }
                        }
                      },
                      0
                    ]
                  },
                  "seller_wallet": {
                    "$arrayElemAt": [
                      {
                        "$map": {
                          "input": "$parties",
                          "as": "p",
                          "in": {
                            "$cond": [
                              { "$eq": ["$$p.role", "seller"] },
                              "$$p.wallet",
                              null
                            ]
                          }
                        }
                      },
                      0
                    ]
                  },
                  "carrier_wallet": {
                    "$arrayElemAt": [
                      {
                        "$map": {
                          "input": "$parties",
                          "as": "p",
                          "in": {
                            "$cond": [
                              { "$eq": ["$$p.role", "carrier"] },
                              "$$p.wallet",
                              null
                            ]
                          }
                        }
                      },
                      0
                    ]
                  }
                }
              },
              {
                "$addFields": {
                  "escrow_doc": {
                    "_id": {
                      "$concat": ["ESCROW-", { "$toString": "$_id" }]
                    },
                    "contract_ref": "$_id",
                    "customer_wallet": "$buyer_wallet",
                    "seller_wallet": "$seller_wallet",
                    "carrier_wallet": "$carrier_wallet",
                    "amount_token": {
                      "$literal": "<TOTAL_CONTRACT_VALUE_IN_TOKEN>"
                    },
                    "token_address": { "$literal": "<TOKEN_CONTRACT_ADDRESS>" },
                    "escrow_contract_address": {
                      "$literal": "<ESCROW_CONTRACT_ON_CHAIN>"
                    },
                    "status": "pending",
                    "created_at": "$$NOW"
                  }
                }
              },
              {
                "$replaceRoot": { "newRoot": "$escrow_doc" }
              },
              {
                "$merge": {
                  "into": "escrow_transactions",
                  "on": "_id",
                  "whenMatched": "fail",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Tạo giao dịch escrow khi hợp đồng được kích hoạt",
            "data_input_from_node": ["multi_party_contracts"],
            "data_output_to_node": ["escrow_transactions"]
          }
        ]
      }
    }
  }
]
